import type { gmail_v1 } from "googleapis";
import type { Email } from "@/domains/gmail/types";
import { simpleParser } from "mailparser";

export class GmailMappers {
<<<<<<< HEAD
	static extractHeader(headers: EmailHeader[], name: string): string | undefined {
		return headers.find((h) => h.name.toLowerCase() === name.toLowerCase())?.value;
	}

	static toEmail(message: gmail_v1.Schema$Message): Email {
		const payload = message.payload;
		const headers: EmailHeader[] = (payload?.headers || []).map((h) => ({
			name: h.name ?? "",
			value: h.value ?? "",
		}));
=======
	static async toEmail(message: gmail_v1.Schema$Message): Promise<Email> {
		if (!message.raw || !message.id) {
			throw new Error("Message raw content is missing");
		}
>>>>>>> f90f018 (refactor(backend): change AI provider, fix Gmail API integration and JSON outputs)

		const messageBuffer = Buffer.from(message.raw, "base64url");

		const mail = await simpleParser(messageBuffer, {
			skipTextToHtml: true,
			skipTextLinks: true,
		});

		for (const [key, value] of Object.entries(mail)) {
			if (!value) {
				console.warn(`${key} isn't defined`);
			}
		}

		if (mail.html === false) {
			throw new Error("Message html content is missing");
		}

		return {
			id: message.id,
			content: mail.text || mail.html,
			snippet: message.snippet ?? undefined,
			subject: mail.subject ?? undefined,
			date: mail.date ?? undefined,
			from: mail.from ?? undefined,
			priority: mail.priority ?? undefined,
			labels: message.labelIds ?? undefined,
			isRead: !message.labelIds?.includes("UNREAD"),
		};
	}

	static formatEmailsForAI(emails: Email[]): string {
		return emails.map((email) => `Email ID:${email.id}\nContent: ${email.content}\n`).join("\n---\n");
	}
}
